{
  "_metadata": {
    "id": "SPO20",
    "title": "Enable Comprehensive SharePoint Audit Events",
    "description": "Configures comprehensive audit logging for SharePoint Online activities by enabling Azure AD B2B integration, restricting custom app authentication to approved apps only, and enabling the unified audit log for ingestion of all SharePoint events. This ensures complete visibility into user activities, sharing events, administrative changes, and application access across all SharePoint sites.",
    "frameworks": [
      "NIS2",
      "ISO 27001:2022",
      "NIST SP 800-53 Rev 5",
      "GDPR (EU) 2016/679",
      "SOC 2",
      "PCI DSS v4.0",
      "HIPAA",
      "FedRAMP Moderate",
      "DORA",
      "CMMC v2.0",
      "HITRUST CSF v11",
      "NYDFS 23 NYCRR 500",
      "UK NCSC CAF v3.2",
      "ASD Essential Eight",
      "Microsoft Cloud Security Benchmark",
      "BSI IT-Grundschutz",
      "NERC-CIP",
      "SEC Cyber Rule"
    ],
    "cisChecks": ["9.1.1"],
    "severity": "High",
    "category": "SharePoint Online",
    "deploymentOrder": 20,
    "requiredLicence": "SharePoint Online (included with Microsoft 365)",
    "version": "1.0",
    "lastUpdated": "2026-02-28",
    "_notes": "This policy combines two complementary settings. EnableAzureADB2BIntegration ensures external collaboration flows through Entra ID B2B, providing audit trails for all guest access. DisableCustomAppAuthentication restricts legacy app-only authentication patterns that can bypass audit logging. UnifiedAuditLogIngestionEnabled ensures all SharePoint events are captured in the Microsoft 365 unified audit log for centralised monitoring and compliance reporting. Audit logs are retained according to your Microsoft 365 licence level (90 days for E3, 365 days for E5 with Audit Premium)."
  },
  "steps": [
    {
      "cmdlet": "Set-SPOTenant",
      "parameters": {
        "EnableAzureADB2BIntegration": true,
        "DisableCustomAppAuthentication": true
      },
      "_notes": "Ensure app-only access is restricted to approved apps. EnableAzureADB2BIntegration routes all external user collaboration through Entra ID B2B, ensuring proper authentication and audit logging. DisableCustomAppAuthentication blocks legacy Azure Access Control Service (ACS) app-only authentication, forcing apps to use modern Entra ID app registrations with proper audit trails."
    },
    {
      "cmdlet": "Set-AdminAuditLogConfig",
      "parameters": {
        "UnifiedAuditLogIngestionEnabled": true
      },
      "_notes": "Enable unified audit log. This ensures all SharePoint Online events (file access, sharing, admin changes, DLP matches, etc.) are ingested into the Microsoft 365 unified audit log. This cmdlet requires Exchange Online PowerShell module connection with appropriate admin permissions."
    }
  ],
  "postDeployment": [
    "Get-SPOTenant | Select-Object EnableAzureADB2BIntegration, DisableCustomAppAuthentication",
    "Get-AdminAuditLogConfig | Select-Object UnifiedAuditLogIngestionEnabled",
    "Verify audit log is capturing events: Search-UnifiedAuditLog -StartDate (Get-Date).AddHours(-1) -EndDate (Get-Date) -RecordType SharePoint -ResultSize 10",
    "Review any existing ACS app registrations that may be affected: Get-SPOTenant | Select-Object DisableCustomAppAuthentication",
    "Inventory existing app registrations using ACS authentication and migrate them to Entra ID app registrations before enforcement if needed",
    "Configure audit log retention policies in Microsoft Purview to meet your regulatory requirements",
    "Set up audit log alerts for critical events: New file sharing with external users, admin role changes, DLP policy violations",
    "Integrate unified audit log with your SIEM solution for centralised security monitoring"
  ]
}