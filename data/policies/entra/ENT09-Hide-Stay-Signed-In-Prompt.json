{
  "_metadata": {
    "id": "ENT09",
    "title": "Hide Stay Signed In Prompt (KMSI)",
    "description": "Disables the 'Stay signed in?' (Keep Me Signed In / KMSI) prompt on the Entra ID sign-in page. Prevents persistent browser sessions on shared or unmanaged devices, reducing the risk of session hijacking. Complements Conditional Access sign-in frequency policies (CA13).",
    "version": "1.0",
    "lastUpdated": "2026-02-27",
    "frameworks": [
      "NIS2", "ISO 27001:2022", "NIST SP 800-53 Rev.5",
      "UK NCSC CAF v3.2", "SOC 2", "GDPR (EU) 2016/679",
      "FedRAMP Moderate", "HITRUST CSF v11", "BSI IT-Grundschutz",
      "DORA", "CMMC v2.0", "NIST CSF 1.1",
      "ASD Essential Eight", "NZ ISM v3.8",
      "MITRE ATT&CK", "Microsoft Cloud Security Benchmark",
      "CJIS v6", "EU Cyber Resilience Act"
    ],
    "cisChecks": ["5.1.2.5"],
    "mitreMappings": ["T1539", "T1550.004"],
    "requiredLicences": ["Microsoft Entra ID Free (included with any M365 plan)"],
    "requiredRoles": ["Global Administrator", "Organizational Branding Administrator"],
    "deploymentOrder": 9,
    "importMethod": "powershell-graph",
    "importScript": "scripts/Import-EntraSettings.ps1"
  },
  "_notes": {
    "prerequisites": [
      "Global Administrator or Organizational Branding Administrator role required",
      "Understand that hiding KMSI will require users to re-authenticate more frequently on all devices",
      "Consider deploying alongside Conditional Access sign-in frequency policies for granular control",
      "Communicate to users that they will no longer see the 'Stay signed in?' prompt",
      "For managed/compliant devices, use Conditional Access persistent browser session policy instead"
    ],
    "impactAssessment": [
      "Users will not see the 'Stay signed in?' prompt after authentication",
      "Browser sessions will use default session lifetime (governed by token lifetime and CA policies)",
      "Users on shared/kiosk devices will benefit from reduced session persistence",
      "Users on personal devices may experience more frequent re-authentication prompts",
      "Primary Refresh Token (PRT) on managed devices is not affected by this setting"
    ],
    "deploymentSteps": [
      "1. Apply the Graph API PATCH to hide the KMSI prompt via organization branding",
      "2. Verify the setting is applied",
      "3. Test sign-in flow to confirm KMSI prompt no longer appears",
      "4. Consider implementing CA sign-in frequency policies for managed device exceptions",
      "5. Communicate the change to users"
    ],
    "rollbackProcedure": "PATCH /organization/{tenant-id}/branding with isHeaderShown or update loginPage hideKeepMeSignedIn to false"
  },
  "graphApiCalls": [
    {
      "stepOrder": 1,
      "description": "Get the organisation branding configuration",
      "method": "GET",
      "endpoint": "https://graph.microsoft.com/v1.0/organization/<TENANT-ID>/branding",
      "headers": {
        "Authorization": "Bearer <ACCESS-TOKEN>"
      },
      "_explanation": "Retrieve the current organisational branding configuration to verify existing settings before modification."
    },
    {
      "stepOrder": 2,
      "description": "Hide the Stay Signed In (KMSI) prompt on the sign-in page",
      "method": "PATCH",
      "endpoint": "https://graph.microsoft.com/v1.0/organization/<TENANT-ID>/branding",
      "headers": {
        "Content-Type": "application/json",
        "Authorization": "Bearer <ACCESS-TOKEN>"
      },
      "body": {
        "loginPage": {
          "hideKeepMeSignedIn": true
        }
      },
      "_explanation": "Sets the hideKeepMeSignedIn property to true on the default organisational branding. This removes the 'Stay signed in?' (KMSI) prompt from the Entra ID sign-in page, preventing users from creating persistent browser sessions."
    },
    {
      "stepOrder": 3,
      "description": "Verify the KMSI prompt is hidden",
      "method": "GET",
      "endpoint": "https://graph.microsoft.com/v1.0/organization/<TENANT-ID>/branding",
      "headers": {
        "Authorization": "Bearer <ACCESS-TOKEN>"
      },
      "expectedResponse": {
        "loginPage": {
          "hideKeepMeSignedIn": true
        }
      }
    }
  ],
  "graphApiCallsBeta": {
    "_description": "Alternative using the beta endpoint with organizationalBranding resource",
    "steps": [
      {
        "stepOrder": 1,
        "description": "Hide KMSI via beta organizationalBranding endpoint",
        "method": "PATCH",
        "endpoint": "https://graph.microsoft.com/beta/organization/<TENANT-ID>/branding",
        "headers": {
          "Content-Type": "application/json",
          "Authorization": "Bearer <ACCESS-TOKEN>"
        },
        "body": {
          "loginPage": {
            "hideKeepMeSignedIn": true
          }
        }
      }
    ]
  },
  "powershellAlternative": {
    "module": "Microsoft.Graph",
    "commands": [
      {
        "description": "Connect to Microsoft Graph with required scopes",
        "command": "Connect-MgGraph -Scopes 'Organization.ReadWrite.All'"
      },
      {
        "description": "Get the current tenant ID",
        "command": "$orgId = (Get-MgOrganization).Id"
      },
      {
        "description": "Get current branding configuration",
        "command": "Get-MgOrganizationBranding -OrganizationId $orgId"
      },
      {
        "description": "Hide the Stay Signed In (KMSI) prompt",
        "command": "Update-MgOrganizationBranding -OrganizationId $orgId -LoginPage @{HideKeepMeSignedIn=$true}"
      },
      {
        "description": "Verify the change",
        "command": "(Get-MgOrganizationBranding -OrganizationId $orgId).LoginPage | Select-Object HideKeepMeSignedIn"
      }
    ]
  },
  "powershellAlternativeLegacy": {
    "_description": "Legacy Azure AD PowerShell (deprecated but included for reference)",
    "module": "AzureADPreview",
    "commands": [
      {
        "description": "Connect to Azure AD",
        "command": "Connect-AzureAD"
      },
      {
        "description": "Hide the KMSI prompt using Set-AzureADTenantBranding (deprecated)",
        "command": "Set-AzureADTenantBranding -HideKeepMeSignedIn $true"
      }
    ],
    "_note": "AzureADPreview module is deprecated. Use Microsoft.Graph module instead."
  },
  "entraPortalPath": {
    "navigation": "Entra admin center > Identity > User experiences > Company branding > Default sign-in experience > Edit > Sign-in form > Show option to remain signed in",
    "setting": "No (unchecked)",
    "_alternativeNavigation": "Entra admin center > Identity > Overview > Properties > Manage Security defaults > Company branding",
    "_note": "The portal setting 'Show option to remain signed in' should be set to No/unchecked to hide the KMSI prompt"
  },
  "complementaryPolicies": {
    "conditionalAccessSignInFrequency": {
      "_description": "For granular session control, configure CA sign-in frequency policies",
      "recommendedSettings": {
        "unmanagedDevices": {
          "signInFrequency": "1 hour",
          "persistentBrowserSession": "never"
        },
        "managedCompliantDevices": {
          "signInFrequency": "7 days",
          "persistentBrowserSession": "always"
        }
      },
      "_note": "CA policies provide more granular control than KMSI alone. KMSI hides the prompt globally; CA policies can differentiate between device types."
    },
    "tokenLifetimePolicy": {
      "_description": "Token lifetime policies control session duration after authentication",
      "defaultValues": {
        "accessTokenLifetime": "1 hour (configurable 10 min - 1 day)",
        "refreshTokenMaxInactiveTime": "90 days",
        "singleFactorRefreshTokenMaxAge": "until-revoked",
        "multiFactorRefreshTokenMaxAge": "until-revoked"
      }
    }
  },
  "sessionSecurityContext": {
    "_description": "Understanding how KMSI interacts with session management",
    "withKMSIEnabled": {
      "behaviour": "User sees 'Stay signed in?' prompt. If accepted, a persistent cookie is set.",
      "persistentCookie": "Session persists across browser restarts",
      "securityRisk": "On shared devices, next user may access the previous user's session"
    },
    "withKMSIDisabled": {
      "behaviour": "No prompt shown. Session cookie is non-persistent by default.",
      "sessionCookie": "Session ends when browser is closed (unless CA policy overrides)",
      "securityBenefit": "Reduces risk of session persistence on shared/unmanaged devices"
    }
  }
}