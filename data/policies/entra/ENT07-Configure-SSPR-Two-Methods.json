{
  "_metadata": {
    "id": "ENT07",
    "title": "Configure Self-Service Password Reset with Two Methods Required",
    "description": "Enables Self-Service Password Reset (SSPR) for all users and requires two authentication methods for password reset. Prevents account takeover via single-method SSPR while reducing helpdesk burden for password resets.",
    "version": "1.0",
    "lastUpdated": "2026-02-27",
    "frameworks": [
      "DORA", "NIS2", "ISO 27001:2022", "NIST SP 800-53 Rev.5",
      "SOC 2", "CMMC v2.0", "UK NCSC CAF v3.2",
      "FedRAMP Moderate", "GDPR (EU) 2016/679",
      "HITRUST CSF v11", "BSI IT-Grundschutz"
    ],
    "cisChecks": ["5.2.4.1"],
    "mitreMappings": ["T1078", "T1110", "T1556"],
    "requiredLicences": [
      "Microsoft Entra ID P1 or P2 (for SSPR)",
      "Microsoft 365 E3 or E5 (includes Entra ID P1/P2)"
    ],
    "requiredRoles": ["Global Administrator", "Authentication Policy Administrator"],
    "deploymentOrder": 7,
    "importMethod": "powershell-graph",
    "importScript": "scripts/Import-EntraSettings.ps1"
  },
  "_notes": {
    "prerequisites": [
      "Entra ID P1 or P2 licence required for SSPR",
      "Users must register at least two authentication methods",
      "Combined registration experience should be enabled",
      "For hybrid environments, password writeback must be configured in Azure AD Connect",
      "Consider enabling the registration campaign to prompt unregistered users"
    ],
    "availableMethods": {
      "microsoftAuthenticatorApp": "Push notification or TOTP code via Microsoft Authenticator",
      "mobilePhone": "SMS or voice call to registered mobile number",
      "email": "Verification code to registered alternative email",
      "securityQuestions": "Pre-registered security questions (not recommended as primary)",
      "officePhone": "Voice call to office phone number"
    },
    "deploymentSteps": [
      "1. Enable combined registration experience if not already enabled",
      "2. Configure SSPR to require 2 methods via Graph API",
      "3. Enable password writeback if hybrid AD (Azure AD Connect)",
      "4. Run a registration campaign to ensure users register methods",
      "5. Test SSPR flow with a test user",
      "6. Monitor registration completeness via Authentication Methods activity"
    ],
    "rollbackProcedure": "Set numberOfAuthenticationMethodsRequired to 1 or disable SSPR via selfServicePasswordResetEnabled: false"
  },
  "graphApiCalls": [
    {
      "stepOrder": 1,
      "description": "Configure SSPR to require 2 authentication methods for all users",
      "method": "PATCH",
      "endpoint": "https://graph.microsoft.com/v1.0/policies/authenticationMethodsPolicy",
      "headers": {
        "Content-Type": "application/json",
        "Authorization": "Bearer "
      },
      "body": {
        "registrationEnforcement": {
          "authenticationMethodsRegistrationCampaign": {
            "state": "enabled",
            "snoozeDurationInDays": 3,
            "includeTargets": [
              {
                "id": "all_users",
                "targetType": "group",
                "targetedAuthenticationMethod": "microsoftAuthenticator"
              }
            ]
          }
        }
      },
      "_explanation": "Enables the registration campaign to ensure users register the Microsoft Authenticator app as an authentication method."
    },
    {
      "stepOrder": 2,
      "description": "Enable SSPR for all users with 2 methods required",
      "method": "PATCH",
      "endpoint": "https://graph.microsoft.com/beta/policies/authenticationMethodsPolicy",
      "body": {
        "selfServicePasswordReset": {
          "isEnabled": true,
          "numberOfAuthenticationMethodsRequired": 2,
          "allowedMethods": [
            "mobilePhone",
            "email",
            "securityQuestions",
            "microsoftAuthenticator"
          ]
        }
      },
      "_explanation": "Enables SSPR for all users requiring 2 of the 4 allowed methods for password reset."
    }
  ],
  "powershellAlternative": {
    "module": "Microsoft.Graph",
    "commands": [
      {
        "description": "Connect to Microsoft Graph",
        "command": "Connect-MgGraph -Scopes 'Policy.ReadWrite.AuthenticationMethod'"
      },
      {
        "description": "Enable registration campaign for Microsoft Authenticator",
        "command": "Update-MgPolicyAuthenticationMethodPolicy -RegistrationEnforcement @{AuthenticationMethodsRegistrationCampaign=@{State='enabled'; SnoozeDurationInDays=3; IncludeTargets=@(@{Id='all_users'; TargetType='group'; TargetedAuthenticationMethod='microsoftAuthenticator'})}}"
      }
    ]
  },
  "entraPortalPath": {
    "navigation": "Entra admin center > Protection > Password reset",
    "settings": {
      "selfServicePasswordResetEnabled": "All",
      "numberOfMethodsRequired": 2,
      "methodsAvailableToUsers": [
        "Mobile app notification (Microsoft Authenticator)",
        "Mobile app code (Microsoft Authenticator)",
        "Mobile phone (SMS/Call)",
        "Email",
        "Security questions"
      ],
      "securityQuestionsRequired": 5,
      "securityQuestionsToReset": 3
    }
  },
  "passwordWritebackConfig": {
    "_description": "For hybrid AD environments, enable password writeback via Azure AD Connect",
    "azureAdConnectSettings": {
      "passwordWritebackEnabled": true,
      "selfServicePasswordResetEnabled": true,
      "_note": "Requires Azure AD Connect v1.4.0.0 or later with password writeback feature enabled"
    }
  }
}